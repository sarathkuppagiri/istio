# EnvoyFilter

EnvoyFilter provides a mechanism to customize the Envoy configuration generated by Istio Pilot. Use EnvoyFilter to modify values for certain fields, add specific filters, or even add entirely new listeners, clusters, etc. This feature must be used with care, as incorrect configurations could potentially destabilize the entire mesh. Unlike other Istio networking objects, EnvoyFilters are additively applied. Any number of EnvoyFilters can exist for a given workload in a specific namespace. The order of application of these EnvoyFilters is as follows: all EnvoyFilters in the config root namespace, followed by all matching EnvoyFilters in the workload’s namespace.

## Install minikube
```
brew install minikube

```

## Start your cluster

```
minikube start

```

## install istio

1. Go to the Istio release page to download the installation file for your OS, or download and extract the latest release automatically (Linux or macOS):

```
curl -L https://istio.io/downloadIstio | sh -

```

2. Move to the Istio package directory. For example, if the package is istio-1.9.4:
```
cd istio-1.14.3
```

3. Add the istioctl client to your path (Linux or macOS):
```
export PATH=$PWD/bin:$PATH

istioctl install --set profile=demo -y

```
4. Create and add a namespace label to instruct Istio to automatically inject Envoy sidecar proxies when you deploy your application later.
```
   kubectl apply -f Chapter09/01-httpbin-deployment.yaml

   curl -H "Host:httpbin.org" http://127.0.0.1:80/get

   Response :

   {
  "args": {},
  "headers": {
    "Accept": "*/*",
    "Host": "httpbin.org",
    "User-Agent": "curl/7.64.1",
    "X-B3-Parentspanid": "4acf0e21a2b75704",
    "X-B3-Sampled": "1",
    "X-B3-Spanid": "d6c97f1005b1359f",
    "X-B3-Traceid": "93893885626eaf1b4acf0e21a2b75704",
    "X-Envoy-Attempt-Count": "1",
    "X-Envoy-Internal": "true",
    "X-Forwarded-Client-Cert": "By=spiffe://cluster.local/ns/demo/sa/default;Hash=eaad307ed60afc19f9b2b8eb7c370961e08a5ab439dd08c123e9e2cda84de5cc;Subject=\"\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"
  },
  "origin": "172.17.0.1",
  "url": "http://httpbin.org/get"
}

Using EnvoyFilter, we will add a custom header to the request before sending it to the httpbin Pod. For this example, let’s pick the ChapterName header name and set its value to ExtendingIstioDataPlane. The configuration in 02-httpbinenvoyfilter-httpbin.yaml adds the custom header to the request.

Apply the following configuration using EnvoyFilter:


$ kubectl apply -f Chapter09/02-httpbinenvoyfilter-httpbin.yaml
envoyfilter.networking.istio.io/updateheaderhorhttpbin configured

we will create an EnvoyFilter named updateheaderforhttpbin in the demo namespace, which will be applied to the workload which has the app label with a httpbin value. For that configuration, we are applying a configuration patch to all inbound traffic to the Istio sidecar aka istio-proxy aka Envoy for port 80 of the httpbin Pod. The configuration patch is applied to HTTP_FILTER and, in particular, to the HTTP router filter of the http_connection_manager network filter.


In the next part of the EnvoyFilter configuration, we apply configuration before the existing route configuration and, in particular, we are appending a Lua filter with inline code as specified in the inlineCode section. The Lua code runs during the envoy_on_request phase and adds a request header with the X-ChapterName name and the ExtendingIstioDataPlane value:

Now, go ahead and test the endpoint using the following command:

curl -H "Host:httpbin.org" http://127.0.0.1:80/get

You will receive the added headers in the response.


Response :

{
  "args": {},
  "headers": {
    "Accept": "*/*",
    "Host": "httpbin.org",
    "User-Agent": "curl/7.64.1",
    "X-B3-Parentspanid": "46d049df91004808",
    "X-B3-Sampled": "1",
    "X-B3-Spanid": "8ea2153e89e4fd75",
    "X-B3-Traceid": "9dea9314ffd3b97d46d049df91004808",
    "X-Chaptername": "ExtendingIstioDataPlane",
    "X-Envoy-Attempt-Count": "1",
    "X-Envoy-Internal": "true",
    "X-Forwarded-Client-Cert": "By=spiffe://cluster.local/ns/demo/sa/default;Hash=eaad307ed60afc19f9b2b8eb7c370961e08a5ab439dd08c123e9e2cda84de5cc;Subject=\"\";URI=spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"
  },
  "origin": "172.17.0.1",
  "url": "http://httpbin.org/get"
}


03-httpbinenvoyfilter-httpbiningress.yaml applies the same changes but at the Ingress gateway level. You can find the example at  03-httpbinenvoyfilter-httpbiningress.yaml. Make sure that you delete the 02-httpbinenvoyfilter-httpbin.yaml file before applying the Ingress gateway changes.

For cleanup, use this command: kubectl delete ns demo.
```